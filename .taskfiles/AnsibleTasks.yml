---
version: '3'
env:
  VAULT_SECRETS_FILE_OBSERVER: group_vars/observer/vault

  # #? create password:
  # echo 'my_vault_password' > .vault_pass
  # echo '.vault_pass' >> .gitignore

  ANSIBLE_VAULT_PASSWORD_FILE: .vault_pass

tasks:

#* General tasks
  comcheck:
    desc: Test connection to all 'linux' end 'win' groups (the 2x main groups)
    ignore_error: true
    cmds:
      - ansible -m ping all

#* Deployment tasks
  init:
    desc: Install the necessary requirements (run only once!)
    ignore_error: false
    cmds:

      # #? https://www.digitalocean.com/community/tutorials/how-to-use-vault-to-protect-sensitive-ansible-data
      # #? http://www.freekb.net/Article?id=2420

      - ansible-galaxy install -r requirements.yml --force                        # this will install the required Ansible roles / collections
      - ansible-vault create $VAULT_SECRETS_FILE_OBSERVER                         # this will create the ansible secret file for the obserer(s)
      - task: verify

  verify:
    desc: Verify Ansible vault
    cmds:
      - cat $VAULT_SECRETS_FILE_OBSERVER                                # raw vault file contents
      - ansible-vault view $VAULT_SECRETS_FILE_OBSERVER                 # decrypted vault file contents
      - ansible -m debug -a 'var=hostvars[inventory_hostname]' observer # debug
      # - ansible-vault view --vault-password-file .vault_pass $VAULT_SECRETS_FILE_OBSERVER    # this will show the  $VAULT_SECRETS_FILE_OBSERVER    contents; assumes you supply the password file from CLI

  dep-monitor:
    desc: Deploy Prometheus monitoring server(s)
    ignore_error: false
    cmds:
      - ansible-playbook provisioning/playbooks/monitoring.yml -t observer  #--ask-vault-pass

  dep-target:
    desc: Deploy Prometheus node exporter on target server(s)
    ignore_error: false
    cmds:
      - ansible-playbook provisioning/playbooks/monitoring.yml -t target  #--ask-vault-pass

  up:
    desc: Deploy complete Prometheus/Grafana stack (observer, target)
    cmds:
      - task: dep-monitor
      - task: dep-target
