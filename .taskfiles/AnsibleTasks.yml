---
version: '3'
env:
  VAULT_SECRETS_FILE_OBSERVER: group_vars/observer/vault

  ANSIBLE_VAULT_PASSWORD_FILE: .vault_pass

tasks:

#* General tasks
  comcheck:
    desc: Test connectivity to the test deployment (we won't ping actual live servers!)
    ignore_error: true
    cmds:
      - ansible -m ping all

#* Deployment tasks
  init:
    desc: Initialize the Ansible work environment
    ignore_error: false
    cmds:

      # #? https://www.digitalocean.com/community/tutorials/how-to-use-vault-to-protect-sensitive-ansible-data
      # #? http://www.freekb.net/Article?id=2420

      #^ install Ansible requirements
      - ansible-galaxy install -r requirements.yml --force

      #^ create vault password for encryption
      - echo 'my_vault_password' > .vault_pass
      - echo '.vault_pass' >> .gitignore

      #^ store the sensitive data in a vault file (need to fill out manually!)
      - ansible-vault create $VAULT_SECRETS_FILE_OBSERVER

      #^ run verification                     # this will create the ansible secret file for the obserer(s)
      - task: verify

  verify:
    desc: Verify if Ansible secrets are present / ready to use
    cmds:
      - cat $VAULT_SECRETS_FILE_OBSERVER                                # raw vault file contents
      - ansible-vault view $VAULT_SECRETS_FILE_OBSERVER                 # decrypted vault file contents
      - ansible -m debug -a 'var=hostvars[inventory_hostname]' observer # debug
      # - ansible-vault view --vault-password-file .vault_pass $VAULT_SECRETS_FILE_OBSERVER    # this will show the  $VAULT_SECRETS_FILE_OBSERVER    contents; assumes you supply the password file from CLI

  build-servers:
    desc: Deploy Prometheus monitoring server(s)
    ignore_error: false
    cmds:
      - ansible-playbook provisioning/playbooks/monitoring.yml -t observer  #--ask-vault-pass

  build-targets:
    desc: Deploy [the test] monitoring target(s)
    ignore_error: false
    cmds:
      - ansible-playbook provisioning/playbooks/monitoring.yml -t target  #--ask-vault-pass

  up:
    desc: Deploy complete Prometheus/Grafana stack (observer, targets)
    cmds:
      - task: build-servers
      - task: build-targets
